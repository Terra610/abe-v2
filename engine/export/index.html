<script>
(async function () {
  // 1. Collect all stored audit data
  const audit = {
    state: localStorage.getItem('abe_state'),
    case_type: localStorage.getItem('abe_case_type'),
    law_analysis: localStorage.getItem('abe_law_block'),
    funding: localStorage.getItem('abe_funding'),
    validity: localStorage.getItem('abe_validity'),
    scorecard: localStorage.getItem('abe_scorecard')
  };

  // 2. Convert audit to JSON
  const jsonText = JSON.stringify(audit, null, 2);

  // 3. Display the JSON in the textarea
  document.getElementById('exportBlock').value = jsonText;

  // 4. Generate SHA-256
  async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  const hash = await sha256(jsonText);

  // 5. Display SHA-256 hash to user
  document.getElementById("hashOutput").textContent = hash;

  // 6. Give user a copy button
  document.getElementById("copyHash").onclick = () => {
    navigator.clipboard.writeText(hash);
    alert("Hash copied to clipboard!");
  };

  // 7. Save hash locally as backup
  localStorage.setItem("abe_last_hash", hash);

})();
</script>
